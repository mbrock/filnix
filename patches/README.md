# Fil-C Patches

This directory contains patches for building upstream software with Fil-C (memory-safe C/C++).

## Overview

- **Total patches**: 75
- **Total size**: 4.3MB
- **Source**: fil-c commit `594c0b05910`
- **Generated by**: `extract-patch.sh`

## What's in the patches

These patches contain **only** the source code changes needed for Fil-C compatibility:

- Pointer-to-integer conversions using `zptrtable_encode()` / `zptrtable_decode()`
- `#include <stdfil.h>` for Fil-C runtime functions
- Build system adjustments (Makefile.am, CMakeLists.txt)
- Platform-specific fixes

## What's excluded

To keep patches minimal and maintainable, we exclude:

- **Autotools generated files**: `configure`, `Makefile.in`, `aclocal.m4`, `config.h.in`
- **Build helper directories**: `build-aux/*`, `conftools/*`
- **Repository infrastructure**: `.github/*`, `.gitignore`, CI configs
- **Gettext/i18n generated files**: `po/Makefile.in.in`, etc.
- **Fil-C test files**: `fil-tests/*` (Filip's test additions)

## Projects needing no patches

These projects build as-is with Fil-C without any modifications:

```
brotli, busybox, bzip2, check, coreutils, curl, dummy-pam-ecryptfs,
emacs-lisp, gmp, kmod, libidn2, libtasn1, lz4, mg, ncurses,
pcre-8.39, pkgconf, shadow, sudo, util-linux, wg14_signals
```

## Using in Nix

Example package override:

```nix
perl = super.perl.overrideAttrs (old: {
  patches = (old.patches or []) ++ [
    ./patches/perl-5.40.0.patch
  ];
});
```

## Regenerating patches

If you need to update patches from a newer fil-c commit:

```bash
# Requires ~/fil-c-projects checkout
make clean
make -j20
```

This will regenerate all patches from the git history in fil-c-projects.

## Largest patches

The biggest patches are for core libraries with extensive changes:

- `user-glibc-2.40.patch` (718K) - Memory-safe user glibc
- `usermusl.patch` (588K) - Memory-safe musl libc
- `nghttp2-1.62.1.patch` (533K) - HTTP/2 library
- `libuev-2.4.1.patch` (517K) - Event loop library
- `pcre2-10.44.patch` (507K) - Regular expressions

## Common patch patterns

### Pointer table usage

Instead of casting pointers to integers:

```c
-    int encoded = PTR2IV(some_ptr);
+    int encoded = zptrtable_encode(my_table, some_ptr);

-    void *decoded = INT2PTR(void*, encoded_val);
+    void *decoded = zptrtable_decode(my_table, encoded_val);
```

### Adding stdfil.h

```c
+#include <stdfil.h>
```

### Initializing pointer tables

```c
+static zptrtable* my_ptrtable;
+
+static void construct_ptrtable(void) __attribute__((constructor));
+static void construct_ptrtable(void)
+{
+    my_ptrtable = zptrtable_new();
+}
```
